import{ae as G,o as W,l as b,k as i,r as m,c as K,Y as le,u as ce,D as de,F as J,f as ue}from"./index-zu87m18r.js";import{d as j,S as Q}from"./types-9AmPez_T.js";import{u as me,T as X,a as Z,b as pe}from"./Tabs-COcCvxIa.js";import{T as ye}from"./TableHeader-DYttKaXK.js";import{F as ee}from"./formPage-D0LEgB12.js";import{u as fe,V as M}from"./index-D84rZFL3.js";import{B as U}from"./BtnToolBar-eoxdJY99.js";import{a as be,u as he}from"./GroupLabel-CFJ4I-sR.js";import{S as ge}from"./SortList-CU7dm2vN.js";import{G as te}from"./GroupButton-DUTfCbto.js";import{V as ve}from"./VF-CFm92MRs.js";const xe=r=>G.delete("/sysTab/remove",{data:r}),qe=r=>G.get(`/sysTabDto/detail/${r}`),Te=r=>G.post("/sysTabDto/list",r),Be=r=>G.post("/sysTabDto/save",r),Ne=r=>G.post("/sysTab/sort",r),we=(r,C,h)=>(r.splice(h,0,r.splice(C,1)[0]),r),Ce=r=>{var I;const{tabs:C,onChange:h,className:y,modelId:$,sysMenuId:E}=r,S=W();return b("div",{children:[i("div",{className:" text-sm  text-gray-400 p-2",children:"上下拖拽进行排序"}),i(ge,{useDragHandle:!0,className:"  bg-gray-100",value:((I=C.sort((d,N)=>(d.sort||0)-(N.sort||0)))==null?void 0:I.map(d=>({id:d.id,name:d.title})))||[],onSortEnd:async({oldIndex:d,newIndex:N})=>{const x=we(C,d,N).map((a,T)=>({...a,sort:T}));Ne(x.map(a=>a.id)).then(a=>{h==null||h(x)})}}),$&&b("div",{onClick:()=>{S(`/full/tableViewConfig/${$}?sysMenuId=${E}`)},className:"mt-2 rounded border border-gray-600 space-x-4 cursor-pointer hover:bg-gray-50  border-dashed h-10 w-full flex items-center justify-center",children:[i("i",{className:" icon-add-member2 text-xl"}),i("div",{children:"创建视图"})]})]})},Se=r=>{const{className:C,formData:h,tableModel:y,btns:$,title:E,onClose:S}=r,[I,d]=m.useState(0),N=m.useRef(null);me(N);const[x,a]=m.useState(h),[T,q]=m.useState([]),[u,V]=K.useState();return m.useEffect(()=>{be(y.entityType).then(n=>{var w,p;q(n.data||[]),V((p=(w=n.data)==null?void 0:w[0])==null?void 0:p.type)})},[y]),b("div",{className:`${C} flex flex-col h-full `,ref:N,children:[b("div",{className:" px-4 py-2",children:[b("div",{className:"flex h-12 w-full items-center !border-b   ",children:[i("div",{className:"font-bold text-xl p-3 text-center",children:E||y.title}),i(te,{className:"flex-1 justify-end",btns:$.map(n=>n.actionType==="edit"&&n.model===y.type?{...n,onSubmitFinish(w){a(w)}}:n.actionType==="create"&&n.model!==y.type?{...n,reaction:[...n.reaction||[],ve.result((w,p)=>{var F;return((F=p==null?void 0:p.fields)==null?void 0:F.find(l=>l.fieldName===`${y.entityType}Id`))!==void 0}).then(`${y.entityType}Id`).value(x.id).readPretty()],onSubmitFinish(w){d(p=>p+1)}}:{...n})||[],datas:h}),i("div",{className:"w-20 justify-center flex",children:i(le,{onClick:S,className:" cursor-pointer hover:text-blue-500"})})]}),i(ee,{terse:!0,modelInfo:y,modifyData:x,readPretty:!0})]}),b("div",{className:" flex  flex-1 flex-col   w-full ",children:[i(X,{className:" w-full mb-2",activeKey:u,tabs:T.map(n=>({key:n.type,name:n.title})),onTabChange:n=>{V(n)}}),i(Z,{className:" flex-1",ignores:[`${y.entityType}Id`],req:{req:{[`${y.entityType}Id`]:x.id}},tableModel:T.find(n=>n.type===u)},u||""+I)]})]})},Le=r=>{const{title:C,conditionReq:h,listModelType:y,listModelId:$,searchFields:E,filterType:S,menu:I,superUser:d="pro",designTabDto:N,onFilterFormData:x}=r,{id:a}=I,T=W(),q=fe("formModal"),[u,V]=m.useState([]),[n,w]=K.useState(),{tableData:p,setTableData:F,user:l,btns:v,app:D}=ce(),[se,O]=m.useState(!1),[_,B]=m.useState(),{model:e}=he($?{id:$}:{type:y}),[L,oe]=K.useState(),[ie,ne]=K.useState(),c=m.useMemo(()=>N||u.find(t=>t.id===n),[n,u,N]),z={title:"查看",actionType:"view",model:e==null?void 0:e.type},g=m.useMemo(()=>{var t,o;if(l!=null&&l.superUser)return(c==null?void 0:c.sysTabButtons)||[];if(l!=null&&l.sysUserGroup_sysGroup&&l.sysUserGroup_sysGroup.length>0){const s=((t=c==null?void 0:c.sysTabVisits)==null?void 0:t.filter(f=>f.sysGroupId&&f.visitButtonIds&&(l==null?void 0:l.sysUserGroup_sysGroup.some(A=>A.id==f.sysGroupId))).map(f=>f.visitButtonIds))||[];return((o=c==null?void 0:c.sysTabButtons)==null?void 0:o.filter(f=>s.some(A=>A.indexOf(f.buttonId)!==-1)))||[]}return[]},[c==null?void 0:c.sysTabButtons,l]),H=m.useMemo(()=>{const t=g==null?void 0:g.filter(o=>o.buttonId&&o.buttonPosition==="tableLine").sort((o,s)=>(o.buttonSort||0)-(s.buttonSort||0)).map(o=>o.buttonId);return[...(t==null?void 0:t.map(o=>v==null?void 0:v.find(s=>s.id===o)).filter(o=>!!o).map(o=>({...j(o,l,e==null?void 0:e.type),sysMenuId:a})))||[],z]},[v,g,l,e==null?void 0:e.type,z]),ae=m.useMemo(()=>{const t={};return e==null||e.fields.filter(o=>o.entityType!==e.entityType).forEach(o=>{t[o.fieldName]=s=>{q.show({type:o.entityType,formData:s,readPretty:!0})}}),t},[e]),P=m.useMemo(()=>{var o;const t=g==null?void 0:g.filter(s=>s.buttonId&&s.buttonPosition==="tableToolbar").map(s=>s.buttonId);return((o=t==null?void 0:t.map(s=>v==null?void 0:v.find(f=>f.id===s)).filter(s=>!((s==null?void 0:s.actionType)==="create"&&s.model===(e==null?void 0:e.type))).filter(s=>!!s))==null?void 0:o.map(s=>({...j(s,l,e==null?void 0:e.type),sysMenuId:a})))||[]},[v,g,e==null?void 0:e.type,l]),R=m.useMemo(()=>{var o;const t=(o=g==null?void 0:g.filter(s=>s.buttonId&&s.buttonPosition==="tableToolbar"))==null?void 0:o.map(s=>s.buttonId);return(t==null?void 0:t.map(s=>v==null?void 0:v.find(f=>f.id===s)).filter(s=>(s==null?void 0:s.actionType)==="create"&&s.model&&s.model===(e==null?void 0:e.type)).map(s=>({...j(s,l,e==null?void 0:e.type),theme:"solid",sysMenuId:a})))||[]},[P,l,g,e==null?void 0:e.type]),re=m.useMemo(()=>{let t={orAnd:"and",where:[],conditions:[]};return h&&(t=de(h)),L&&(t={...t,conditions:[...t.conditions,L]}),t},[h,L,c,I]),Y=m.useCallback(async()=>{if(a)return Te({req:{sysMenuId:a}}).then(t=>{var o,s;V(t.data||[]),w((s=(o=t.data)==null?void 0:o.sort((f,A)=>f.sort-A.sort))==null?void 0:s[0].id)})},[a]),k=m.useMemo(()=>u.length===1?[]:(u==null?void 0:u.sort((t,o)=>t.sort-o.sort).map(t=>({name:t.title,key:t.id,icon:t.icon,conditions:{orAnd:"and",where:[],conditions:[]}})))||[],[u]);return m.useEffect(()=>{Y()},[a]),c?b("div",{className:" flex flex-col h-full bg-slate-50 ",children:[e&&a&&d!=="design"&&i(ye,{className:" border-t  w-full bg-white shadow",btns:R,label:C||I.name||e.title,sysMenuId:a,model:e,children:d===!0&&b("div",{className:"flex space-x-1 items-center",children:[i(M,{tooltip:"表单配置",btnType:"icon",allowEmpty:!0,icon:i("i",{className:" icon-build text-gray-500  hover:bg-gray-200 hover:text-blue-500 p-1 rounded-md cursor-pointer"}),actionType:"click",onClick:()=>{T(`/full/formDesign/${e==null?void 0:e.id}`)}}),(!k||k.length<=1)&&(D==null?void 0:D.appKey)!=="sys"&&i(U,{btns:[{title:"添加新的视图",icon:i("i",{className:"icon-task_add-02 font-bold hover:bg-gray-200 hover:text-blue-500 p-1 rounded-md cursor-pointer"}),btnType:"icon",allowEmpty:!0,actionType:"click",onClick:()=>{T(`/full/tableViewConfig/${e.id}?sysMenuId=${a}`)}}]})]})},e.id),k&&k.length>0&&e&&d!=="design"&&i(X,{superUser:d,activeKey:n,tabs:k||[],tabBtn:d===!0&&i(U,{dropdown:i("i",{className:"icon-arrow-down-border"}),btns:[{title:"编辑视图",actionType:"click",btnColor:"tertiary",theme:"borderless",allowEmpty:!0,onClick:()=>{T(`/full/tableViewConfig/${e.id}?sysTabId=${n}`)}},{title:"删除视图",actionType:"api",saveApi:xe,multiple:!0,datas:u==null?void 0:u.find(t=>{var o;return t.id===(p.tabActiveKey||((o=k==null?void 0:k[0])==null?void 0:o.key))}),onSubmitFinish:t=>{Y()}}]}),onTabChange:t=>{w(t),F(o=>({...o,tabActiveKey:t,selected:[]}))},children:d===!0&&(D==null?void 0:D.appKey)!=="sys"&&b(J,{children:[i(M,{title:"添加新的视图",actionType:"click",onClick:()=>{T(`/full/tableViewConfig/${e.id}?sysMenuId=${a}`)},allowEmpty:!0,icon:i("i",{className:"icon-task_add-02 font-bold"}),btnType:"icon"}),((u==null?void 0:u.length)||0)>1&&b(J,{children:[i(M,{title:"视图排序",actionType:"click",onClick:()=>{O(!0)},allowEmpty:!0,icon:i("i",{className:" icon-table_rows"}),btnType:"icon"}),i(Q,{title:"视图",visible:se,onCancel:()=>O(!1),closeOnEsc:!0,children:i(Ce,{sysMenuId:a,modelId:e.id,tabs:u,onChange:V})})]})]})}),b("div",{className:"flex flex-1 w-full px-2 mt-2 bg-slate-50 space-x-2 ",children:[S&&i(ee,{className:"w-60 bg-white p-4 rounded border h-full",type:S,fontBold:!1,onChange:t=>{ne({...t}),x==null||x({...t})}}),b("div",{className:`flex flex-col ${ue({"flex-1 overflow-hidden":S!==void 0,"w-full":S===void 0})}`,children:[e&&c&&i(pe,{className:"w-full h-10 rounded-t-xl border bg-white ",leftBtns:P&&P.length>0?i(te,{position:"tableToolbar",activeKey:p.tabActiveKey,btns:P.map(t=>({...t,theme:"borderless",onSubmitFinish:t.onSubmitFinish||(o=>{F(s=>({...s,selected:[],loadDataFlag:s.loadDataFlag+1}))})})),datas:p==null?void 0:p.selected}):d==="design"&&P.length===0&&R.length===0?b("span",{className:"  text-sm",children:["请在右侧[",i("span",{className:" text-red-500",children:"按钮配置"}),"]栏添加按钮"]}):void 0,tableModel:e,searchFields:E,rightBtns:d==="design"?R:[],onSearchChange:oe,children:d===!0&&i(U,{btns:[{title:"视图配置",icon:i("i",{className:" icon-build text-gray-500  hover:bg-gray-200 hover:text-blue-500 p-1 rounded-md cursor-pointer"}),tooltip:"视图配置",actionType:"click",btnColor:"tertiary",theme:"borderless",btnType:"icon",allowEmpty:!0,onClick:()=>{T(`/full/tableViewConfig/${e.id}?sysMenuId=${a}&sysTabId=${n}`)}}]})}),e&&c&&c.sysMenuId===a&&i(Z,{sysTabDto:c,className:"flex flex-1 border-b border-x bg-white",tableModel:e,req:{...ie,conditions:re},btns:H,onFieldClick:ae,onLineClick:c.formShowType==="relation_subs"?t=>{B(t)}:void 0}),i(Q,{headerStyle:{padding:"0px",zIndex:10},bodyStyle:{padding:"0px"},visible:!!_,width:1200,closable:!1,onCancel:()=>{B(void 0)},closeOnEsc:!0,children:i(Se,{tableModel:e,formData:_,onClose:()=>B(void 0),className:" p-2 bg-gray-50 ",btns:H})})]})]})]}):i("div",{className:"  justify-center flex items-center  text-red-400",children:"当前没有任何视图"})};export{Le as P,Be as a,qe as s};
