import{j as v,d as r,r as h,aw as k,F as V,aI as S,aH as _,c as te}from"./index-SxAtwMns.js";import{L as le,j as B,g as W,S as ae}from"./index-BLqHf6AC.js";import{S as O,b as Q}from"./index-Kh_0iifu.js";import{F as R}from"./index-DtzUPu3w.js";import{w as se,x as ie,l as J,y as X,C as re,z as ce,u as ne,A as M,D as oe}from"./formPage-DEYoTnuZ.js";import{l as de}from"./SysApp-BMXU6j0c.js";var z=function(){return z=Object.assign||function(e){for(var o,i=1,c=arguments.length;i<c;i++){o=arguments[i];for(var f in o)Object.prototype.hasOwnProperty.call(o,f)&&(e[f]=o[f])}return e},z.apply(this,arguments)},Y=se(le,ie(function(e){var o=e.onChange;return z(z({},e),{onChange:function(i,c){o&&o(c,c)}})}));const P=({label:e,icon:o,code:i,remark:c,required:f})=>v("div",{className:"text-sm flex font-medium items-center  ",children:[v("div",{className:" h-full",children:[e&&r("div",{className:"text-sm text-gray-700 whitespace-nowrap ",children:e}),i&&r("div",{className:"text-xs text-gray-400 whitespace-nowrap ",children:i})]}),f&&r("i",{className:" icon-emergency font-medium text-xs text-red-500 mx-2"})]}),Z=({propInfo:e,value:o,propName:i,field:c,listNo:f,formVo:s,subName:T,className:t="",onChange:b})=>{const d="conditionJson",[u,l]=h.useState({...o,propName:i,subName:T,listNo:f}),[C,m]=h.useState([]),[a,p]=h.useState((c==null?void 0:c.entityType)===(s==null?void 0:s.type)?s:void 0);h.useEffect(()=>{a||J({type:c==null?void 0:c.entityType}).then(y=>{var j;p((j=y.data)==null?void 0:j[0])})},[a,c]);const[F,D]=h.useState(k.fixed);return h.useEffect(()=>{e.options&&(!Array.isArray(e.options)&&typeof e.options=="object"&&e.options.apiInfoKey?X(e.options).then(y=>{m(y)}):typeof e.options=="function"&&c?e.options(c).then(y=>{m(y)}):m(e.options))},[e,c]),B(()=>{b({...u,sourceType:F})},[u,F]),e.fromField===void 0||e.fromField===!0?v("div",{className:`flex space-x-2 w-full justify-between items-center ${t}`,children:[r(P,{code:`${f!==void 0&&T!==void 0?f+1+"_":""}${T||i}
            `,label:e.label,required:e.required,remark:e.remark,icon:r("i",{className:" text-blue-400  icon-knowledge_file "})}),e.fromField===void 0&&r(V,{children:e.options?r(V,{children:C&&r(O,{showClear:!0,className:"w-full",optionList:C,placeholder:`请选择${T||i}属性值`,value:u.propVal,onChange:y=>{l({...u,propVal:y})}})}):v(V,{children:[e.dataModel===S.string&&(i!==d?r(R,{className:"w-full",value:u.propVal,placeholder:`请录入${T||i}属性值`,onChange:y=>{l({...u,propVal:y})}}):r(re,{model:a,emptyLabel:"过滤条件设置",value:u.propVal,onChange:y=>{l({...u,propVal:y})}})),e.dataModel===S.date&&r(Y,{value:u.propVal,placeholder:`组件${T||i}属性`,onChange:y=>{l({...u,propVal:y})}}),e.dataModel===S.number&&r(W,{value:u.propVal,onChange:y=>{l({...u,propVal:y})}}),e.dataModel===S.boolean&&r(Q,{checked:u.propVal==="1",value:u.propVal,onChange:y=>{l({...u,propVal:y.target.checked?"1":"0"})}}),e.dataModel===S.image&&r(ce,{value:u.propVal,onChange:y=>{l({...u,propVal:y})}}),e.dataModel===S.icon&&r(ae,{value:u.propVal,onChange:y=>{l({...u,propVal:y})}})]})}),e.fromField===!0&&s&&r(O,{showClear:!0,className:"w-full",placeholder:`属性${i}值等于的字段选取`,emptyContent:"未找到类型匹配的字段",optionList:s.fields.filter(y=>y.dataType===e.dataType&&y.fieldType===e.dataModel&&y.fieldName!==(c==null?void 0:c.fieldName)).map(y=>({label:`${y.title}(${y.fieldName})`,value:y.fieldName})),value:u.propVal,onChange:y=>{l({...u,propVal:y})}})]}):r("div",{className:" hidden",children:"fromField不为true且有值则不用进行展示，需要再组件选择的时候判断是否匹配； 组件属性使用fromfield的一般情况都是组件与接口绑定死了是，是模块不是组件"})},K=e=>{const{model:o,value:i,className:c,excludeField:f,dataType:s,supportFromMaster:T=!1,onChange:t}=e,{getModel:b}=ne(),[d,u]=h.useState(void 0);return h.useEffect(()=>{i&&(i==null?void 0:i.indexOf("."))>-1?b({type:i.split(".")[0]}).then(l=>{u(l)}):u(void 0)},[i]),h.useEffect(()=>{T&&J()},[T,o]),v("div",{className:`${c} w-full flex flex-col`,children:[r(O,{showClear:!0,emptyContent:"未找到类型匹配的字段",className:"w-full",optionList:[...o.fields.filter(l=>(s?l.dataType===s:!0)&&!(f||[]).includes(l.fieldName)).map(l=>({label:`${l.title}(${l.fieldName})`,value:l.fieldName})),...o.fields.filter(l=>l.entityFieldName==="id"&&l.entityType!==o.entityType).map(l=>({label:`从[${l.title}]选择字段`,value:l.entityType+"."}))],value:i&&(i==null?void 0:i.indexOf("."))!==-1?(i==null?void 0:i.split(".")[0])+".":i,onChange:l=>{t(l)}}),d&&i&&r(K,{model:d,dataType:s,value:i.split(".")[1],onChange:l=>{t(i+l)}})]})},ue=({value:e,paramName:o,propName:i,formVo:c,field:f,paramInfo:s,onChange:T})=>{const[t,b]=h.useState({...e,paramName:o}),[d,u]=h.useState(k.fixed),[l,C]=h.useState();h.useEffect(()=>{s.options&&(Array.isArray(s.options)?C(s.options):typeof s.options=="object"&&s.options!==null?X(s.options).then(a=>{C(a)}):alert("api接口参数不能来源于接口"))},[s]),B(()=>{T(t)},[t]);const m=h.useMemo(()=>{const a="";return s.fromField!==void 0?s.fromField===!0?a+"该参数的数据来自当前表单的其他字段":a+"该参数的数据来自当前表单指定字段":s.options?a+"下拉选择项内容来自接口配置项params->options":""},[s,i]);return v("div",{className:"flex space-x-2 mb-2 w-full mt-2 items-center",children:[r(P,{required:s.required,code:o,label:s.label,remark:s.remark||m,icon:r("i",{className:" text-red-400  icon-laptop_mac  "})}),s.fromField===void 0&&v(V,{children:[l&&r(O,{className:"w-full",placeholder:`${s.label}`,optionList:l,value:t.paramVal,onChange:a=>{b({...t,sourceType:d,paramVal:a==null?void 0:a.toString()})}}),(s.dataType===void 0||s.dataType==="basic")&&s.options===void 0&&s.fromField===void 0&&v(V,{children:[s.dataModel===S.string&&r(R,{className:"w-full",value:t.paramVal,placeholder:`${s.remark}`,onChange:a=>{b({...t,sourceType:d,paramVal:a})}}),s.dataModel===S.date&&r(Y,{value:t.paramVal,placeholder:`${s.label}`,onChange:a=>{b({...t,sourceType:d,paramVal:a.toString()})}}),s.dataModel===S.number&&r(W,{value:t.paramVal,placeholder:`${s.label}`,onChange:a=>{b({...t,sourceType:d,paramVal:a.toString()})}}),s.dataModel===S.boolean&&r(Q,{value:t.paramVal,onChange:a=>{b({...t,sourceType:d,paramVal:a.target.checked})}})]})]}),s.fromField===!0&&c&&r(K,{model:c,dataType:s.dataType,value:t.paramVal,excludeField:[f==null?void 0:f.fieldName,"id"],onChange:a=>{b({...t,sourceType:d,paramVal:a==null?void 0:a.toString()})}}),s.fromField&&s.fromField!==!0&&r("div",{className:" w-full text-sm text-red-500 flex",children:c&&(c==null?void 0:c.fields.filter(a=>a.entityType===s.fromField.entity).filter(a=>a.dataType!=="array").filter(a=>{var p;return a.entityFieldName===((p=s.fromField)==null?void 0:p.field)}).length)>0?r(V,{children:`已将该入参与表单"${c==null?void 0:c.fields.filter(a=>a.entityType===s.fromField.entity).filter(a=>a.dataType!=="array").filter(a=>{var p;return a.entityFieldName===((p=s.fromField)==null?void 0:p.field)})[0].fieldName}"字段关联,数据可联动`}):r(V,{children:"该入参可不传，当前未匹配到"})}),s.fromField===void 0&&s.dataType!==void 0&&s.dataType!==_.basic&&c&&r("div",{className:" w-full text-sm text-red-500 flex",children:`${o}没有指定来源(fromField)`})]})},he=({data:e,onChange:o})=>{var i,c,f,s,T,t,b;return h.useEffect(()=>{},[]),r(V,{children:e.propVal&&e.sourceType===k.api&&((i=M[e.propVal])==null?void 0:i.filters)&&(e.relateVal===void 0||((f=(c=M[e.propVal])==null?void 0:c.match)==null?void 0:f[e.relateVal].dataType)==="array"&&((t=(T=(s=M[e.propVal])==null?void 0:s.match)==null?void 0:T[e.relateVal].filterKey)==null?void 0:t.length)!==0)&&v(V,{children:[v("div",{className:"flex space-x-2 mb-2 w-full mt-2 items-center",children:[r(P,{label:"数据筛选",icon:r("i",{className:" icon-filter_list  text-gray-400 "})}),r(O,{showClear:!0,multiple:!0,placeholder:"对数据做进一步过滤",style:{width:"90%"},value:e&&e.filterFunc&&e.filterFunc.length>0?e.filterFunc.split(","):void 0,optionList:Object.keys(((b=M[e.propVal])==null?void 0:b.filters)||{}).filter(d=>{var u,l,C,m,a;return((l=(u=M[e.propVal])==null?void 0:u.match)==null?void 0:l[(e==null?void 0:e.relateVal)||""].filterKey)===void 0||((a=(m=(C=M[e.propVal])==null?void 0:C.match)==null?void 0:m[(e==null?void 0:e.relateVal)||""].filterKey)==null?void 0:a.includes(d))}).map(d=>{var u,l;return{label:(l=(u=M[e.propVal])==null?void 0:u.filters)==null?void 0:l[d].title,value:d}}),onChange:d=>{o({filterFunc:(d==null?void 0:d.toString())||"",filterConnectionType:e.filterConnectionType||"or"})}})]}),e.filterFunc&&e.filterFunc.split(",").length>1&&v("div",{className:"flex space-x-2 mb-2 w-full mt-2 items-center",children:[r(P,{label:"筛选整合",remark:"经过2个以上筛选过滤器分别处理后的数据连接整合方式",icon:r("i",{className:" text-red-400 icon-link_record"})}),r(O,{showClear:!0,style:{width:"90%"},optionList:[{label:"取多次筛选的交集数据",value:"and"},{label:"取多次筛选的并集数据",value:"or"}],value:e.filterConnectionType,onChange:d=>{o({filterFunc:e.filterFunc||"",filterConnectionType:(d==null?void 0:d.toString())||""})}})]})]})})},ye=(e,o)=>e.dataModel.toLowerCase()===o.dataModel.toLowerCase()&&(e.dataType||"basic")===(o.dataType||"basic");function me(e){const o=Object.keys(e||{});return o==null?void 0:o.filter(i=>e&&e[i]&&typeof e[i]=="object"&&e[i].fromField&&e[i].fromField!==!0&&e[i].required==!0).map(i=>(e==null?void 0:e[i]).fromField)}const U=M,I=({propInfo:e,propName:o,lineNo:i,formVo:c,field:f,value:s,onChange:T})=>{const[t,b]=h.useState(s&&s.length>0?{...s[0]}:{listNo:e.dataSub?i:void 0,propName:o,sourceType:k.api}),[d,u]=h.useState(),[l,C]=h.useState(),[m,a]=h.useState();h.useEffect(()=>{de({}).then(n=>{u(n.data)}),J().then(n=>{a(n.data)})},[]),h.useEffect(()=>{var n,x;t.propVal&&t.sourceType===k.api&&C(((x=(n=m==null?void 0:m.filter(w=>{var g;return w.type.toLowerCase()===((g=M[t.propVal])==null?void 0:g.dataModel.toLowerCase())}))==null?void 0:n[0])==null?void 0:x.sysAppId)||"other")},[t,m]);const[p,F]=h.useState([]);h.useEffect(()=>{const n=e.dataType,x=e.dataModel,w=[];Object.keys(M).forEach(g=>{const N=M[g].match;Object.keys(N).forEach(ee=>{var H;const G=N[ee];let A=[];if(G.params&&(A=me(G.params)),A==null||A.length===0||A.filter($=>(c==null?void 0:c.fields.filter(L=>L.entityType===$.entity&&L.entityFieldName===$.field&&L.dataType!=="array").length)===1).length===A.length){let $=(H=m==null?void 0:m.filter(E=>E.type.toLowerCase()===M[g].dataModel.toLowerCase()))==null?void 0:H[0];M[g].dataType===n&&M[g].dataModel===x.toLowerCase()&&(l===void 0||$&&$.sysAppId===l||$===void 0&&l==="other")&&w.push({label:M[g].label,value:g});const L=M[g].match;L&&Object.keys(L).filter(E=>L[E].dataType===n&&L[E].dataModel.toLowerCase()===x.toLowerCase()).forEach(E=>{(l===void 0||$&&$.sysAppId===l||$===void 0&&l==="other")&&w.push({label:M[g].label+(L[E].label?`(${L[E].label})`:""),value:g+","+E})})}})}),F(w)},[e,l,m]);const D=h.useMemo(()=>{const n=e.dataType,x=e.dataModel;return oe(m||[]).filter(g=>g.dataType===n&&(g.dataModel.toLowerCase()===x.toLowerCase()||g.parentClass.filter(N=>N.toLowerCase()===x.toLowerCase()).length>0)&&(l===void 0||g.app===l)).map(g=>({label:g.apiLabel+(g.matchLabel?`(${g.matchLabel})`:""),value:g.apiKey+","+g.matchKey}))},[e,l,m]);h.useEffect(()=>{e.apiMatch&&b({...t,sourceType:k.api,propVal:e.apiMatch.apiInfoKey,relateVal:e.apiMatch.match,filterFunc:e.apiMatch.filterFunc,filterConnectionType:e.apiMatch.filterConnectionType})},[p,e]),B(()=>{T([{...t}])},[t]);const y=h.useCallback(n=>{if(n){const x=U[n];if(x){const w=x.match;if(w)return Object.keys(w).filter(g=>ye(w[g],e)).map(g=>({label:w[g].label||x.label,value:g}))}}return[]},[e]);h.useEffect(()=>{if(t.sourceType===k.api&&t.propVal){const n=y(t.propVal);n&&n.length===1&&b({...t,relateVal:n[0].value})}},[t.propVal,t.sourceType]);const j=h.useMemo(()=>{var x,w,g;const n={};if(t.relateVal&&t.propVal){const N=(g=(w=(x=U[t.propVal])==null?void 0:x.match)==null?void 0:w[t==null?void 0:t.relateVal])==null?void 0:g.params;N&&Object.keys(N).map(q=>{typeof N[q]=="object"&&(n[q]=N[q])})}return n},[t]);return r("div",{className:" w-full",children:e.dataSub?v("div",{children:[v("div",{className:"text-xs justify-between flex box-border font-semibold text-gray-700 mb-1 mt-0 pr-4 align-middle leading-5 tracking-normal flex-shrink-0",children:[r("div",{children:`${e.label}(${o})`}),r("div",{className:" text-gray-500",children:i!==void 0?`第${i+1}组 `:""})]}),r("div",{className:" border-t border-dashed   relative "}),r(be,{formVo:c,field:f,propConf:e.dataSub,value:s,lineNo:i,parentName:o,onChange:n=>{T(n)}})]}):v("div",{children:[e.apiMatch===void 0&&v("div",{className:"flex space-x-2 mb-2 w-full mt-2 items-center",children:[r(P,{required:e.required,code:o,label:e.label,remark:e.remark||`该属性数据来源于ApiDatas.ts里定义的出参类型为${e.dataModel}<${e.dataType}>接口`,icon:r("i",{className:"icon-api text-blue-400"})}),v("div",{className:"flex w-full space-x-1",children:[r(O,{className:" w-44",value:l,placeholder:"应用选择",optionList:[...(d==null?void 0:d.map(n=>({value:n.id,label:n.name})))||[],{value:"other",label:"其他"}],onChange:n=>{C(n==null?void 0:n.toString()),b(x=>({...x,relateVal:void 0,propVal:void 0}))}}),r(O,{optionList:D,showClear:!0,value:(t.propVal||"")+(t.relateVal?","+t.relateVal:""),placeholder:`${e.label}`,onChange:n=>{const x=(n==null?void 0:n.toString().split(","))||[];(n==null?void 0:n.toString().split(",").length)===2&&b(w=>({...w,filterFunc:void 0,relateVal:x.length===2?x[1]:void 0,sourceType:k.api,propVal:x[0]}))},className:"w-full"})]})]}),v("div",{className:"bg-blue-50",children:[j&&Object.keys(j).length>0&&r("div",{className:" w-full",children:Object.keys(j).map(n=>r(ue,{formVo:c,field:f,paramInfo:j[n],paramName:n,propName:o,value:t.params&&t.params.filter(x=>x.paramName===n).length>0?t.params.filter(x=>x.paramName===n)[0]:void 0,onChange:x=>{b({...t,params:t.params?[...t.params.filter(w=>w.paramName!==n),x]:[x]})}},n))}),t.sourceType===k.api&&r(he,{data:t,onChange:n=>{b(x=>({...x,...n}))}})]})]})})},pe=({propInfo:e,value:o,field:i,formVo:c,propName:f,onChange:s,...T})=>{const[t,b]=h.useState(o===void 0||o.length===0?[{listNo:0,propName:f}]:o);B(()=>{s(t)},[t]);const d=h.useMemo(()=>new Set(t.map(a=>a.listNo)).size,[t]),u=h.useCallback(()=>{b([...t,{listNo:d,propName:f}])},[t,d]),l=h.useCallback(a=>{const p=t.filter((F,D)=>F.listNo!==a);b([...p])},[t]),C=h.useMemo(()=>e.dataModel===S.string||e.dataModel===S.boolean||e.dataModel===S.number||e.dataModel===S.date,[e]),m=h.useCallback((a,p)=>{const F=t.filter((D,y)=>D.listNo!==a);b([...F,...p])},[t]);return v(V,{children:[[...new Set(t.map(a=>a.listNo))].sort().map(a=>a!==void 0?r("div",{children:r("div",{children:C?r(Z,{formVo:c,field:i,propName:f,listNo:a,propInfo:e,value:t[a],onChange:p=>{m(a,[p])}},"basic"+a):r(I,{formVo:c,field:i,value:t.filter(p=>p.listNo===a),onChange:p=>{m(a,p)},lineNo:a,propName:f,propInfo:e},"object"+a)})},f+a):r(V,{})),e.dataType===_.array&&(e.dataSub!==void 0||e.dataModel==="string")&&v("div",{className:"flex w-full justify-between text-sm mt-1 ",children:[v("div",{onClick:u,className:" px-2  hover:text-blue-500 cursor-pointer space-x-2  text-sm ",children:[r("i",{className:" icon-create-network"}),r("span",{className:"text-xs text-gray-500 hover:text-blue-500 ",children:"添加新的"})]}),d>1&&v("div",{onClick:()=>l(d-1),className:" hover:text-blue-500 text-xs text-gray-500 cursor-pointer text-right ",children:[r("i",{className:"  icon-remove_circle_outline"})," 删除最后一条"]})]})]})},be=({parentName:e,propConf:o,lineNo:i,formVo:c,sourceForm:f,field:s,className:T="",value:t,onChange:b})=>{const d=h.useMemo(()=>{const l={};return Object.keys(o).forEach(C=>{typeof o[C]=="object"&&(l[C]=o[C])}),l},[o]),u=h.useCallback((l,C)=>(t==null?void 0:t.filter(m=>m.propName===l).filter(m=>C?m.subName===C:!0))||[],[t]);return r("div",{className:`${T} `,children:Object.keys(d).filter(l=>{var C,m,a;return(C=d[l])!=null&&C.modelMatch&&s&&f&&c?((a=(m=d[l])==null?void 0:m.modelMatch)==null?void 0:a.call(m,{field:s,sourceForm:f,form:c}))===!0:!0}).map(l=>{const C=d[l].dataType,m=d[l].options;return v("div",{className:`  ${te({"":i===void 0,hidden:l==="sourceData"})}  `,children:[(C===_.basic||C===void 0&&m)&&r(Z,{className:"my-2 ",formVo:c,field:s,propName:e||l,subName:e?l:void 0,propInfo:d[l],listNo:i,value:u(e||l,e?l:void 0)[0],onChange:a=>{if(e!==void 0&&i!==void 0){const p=t==null?void 0:t.filter(F=>!(F.propName===e&&F.subName===l&&F.listNo===i)).filter(F=>F.subName!==void 0);b([...p||[],a])}else b(e!==void 0?[...(t==null?void 0:t.filter(p=>!(p.propName===e&&p.subName===l)))||[],a]:i!==void 0?[...(t==null?void 0:t.filter(p=>!(p.propName===l&&p.listNo===i)))||[],a]:[...(t==null?void 0:t.filter(p=>p.propName!==l))||[],a])}}),C===_.object&&r(I,{lineNo:i,formVo:c,field:s,propName:e||l,propInfo:d[l],value:u(l),onChange:a=>{b([...(t==null?void 0:t.filter(p=>p.propName!==l))||[],...a])}}),C===_.array&&r(pe,{formVo:c,field:s,propName:e||l,propInfo:d[l],value:u(l),onChange:a=>{b([...(t==null?void 0:t.filter(p=>p.propName!==l))||[],...a])}})]},l)})})};export{be as C};
