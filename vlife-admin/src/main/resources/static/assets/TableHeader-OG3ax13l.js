import{a0 as C,r as u,j as l,F,d as t,au as k,B as j,u as T}from"./index-BNDtW2eT.js";import{g as $,S as q}from"./index-C6DPW6pI.js";import{G as w}from"./GroupButton-D5eFJVxs.js";import{l as B}from"./formPage-BHPYqPSB.js";const P="",y=r=>C.get(`${P}/excel/template/${r}`,{responseType:"blob"}),U=r=>C.post("/excel/importData",r,{headers:{"Content-Type":"multipart/form-data"}}),z=({entityType:r,onFinish:m,onChange:x})=>{const[e,b]=u.useState(),[i,p]=u.useState({entityType:r,override:!0,file:void 0}),f=a=>{if(a.size>1024*1024)return!1;const o=a.name,v=o.substring(o.lastIndexOf(".")+1);return!!["xlsx","xls"].includes(v)},[c,h]=u.useState(!1),[s,d]=u.useState("import"),[n,g]=u.useState(),D=a=>{const o=a.target.files[0];p({...i,file:o})};u.useEffect(()=>{B({type:r}).then(a=>{var o,v,S;b((o=a.data)==null?void 0:o[0]),((S=(v=a.data)==null?void 0:v[0])==null?void 0:S.fields.filter(E=>E.validate_unique).length)===0&&d("modelError")})},[r]);const N=u.useMemo(()=>e==null?void 0:e.fields.filter(a=>a.validate_unique).map(a=>a.title).join(","),[e]);return l("div",{className:" relative p-4 space-y-4 h-96 flex flex-col ",children:[l(F,{children:[l("div",{children:[l("div",{className:" font-bold mb-2 ",children:["一、请按照数据模板的格式准备要导入的数据。点击下载",l("a",{className:" text-blue-500 cursor-pointer",onClick:()=>{y(r)},children:["《",e==null?void 0:e.title,"数据模板》"]})]}),t("div",{children:"请勿修改表格标题，防止导入失败,一次导入数据量控制在1000条以内"})]}),l("div",{children:[l("div",{className:" font-bold mb-2",children:["二、请选择数据重复时的处理方式（查重规则：",N,"）"]}),l("div",{className:"mb-2",children:["查重规则为：添加",e==null?void 0:e.title,"时所需填写的所有唯一字段，当前设置唯一字段为：",N]}),t("div",{children:t($,{value:i.override?"override":"skip",onChange:a=>{p({...i,override:a==="override"})},optionList:[{label:"覆盖系统原有数据",value:"override"},{label:"跳过",value:"skip"}]})})]}),l("div",{children:[t("div",{className:" font-bold mb-2",children:"三、请选择需要导入的文件"}),t("div",{className:"mb-2",children:t("input",{type:"file",onChange:D,className:"bg-blue-300 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded"})}),i.file&&f(i.file)===!1&&l("div",{className:" text-xs text-red-500 font-bold",children:["请选择excel文件进行导入",l("a",{href:"#",className:" text-blue-500 cursor-pointer",onClick:()=>{y(r)},children:["模版下载-《",e==null?void 0:e.title,"数据模板》"]})]})]})]}),s==="result"&&l("div",{className:"text-center  pt-20",children:[c&&t("div",{children:l("div",{children:[t(k,{size:"large"})," ",t("span",{children:"数据导入中..."})]})}),n!==void 0&&l(F,{children:[t("div",{className:" font-bold text-2xl",children:n.success&&n.total>0&&n.success>0?"导入成功":"导入失败"}),t("div",{className:" text-blue-500 font-bold",children:n.msg})]})]}),s==="modelError"&&t("div",{className:" font-bold text-red-500  mt-4",children:"导入的数据模型，必须设置至少一个字段为唯一的，不能重复的"}),s!=="modelError"&&t("div",{className:"absolute  right-4  bottom-4",children:t(j,{loading:c,disabled:!i.file||i.file&&f(i.file)===!1,onClick:()=>{s==="import"?(d("result"),g(void 0),h(!0),U(i).then(a=>{g(a.data),h(!1),m==null||m()})):(p({...i,file:void 0}),d("import"))},children:s==="import"||c?"数据导入":"继续导入"})})]})},L=({className:r,label:m,sysMenuId:x,model:e,imp:b,btns:i,children:p})=>{const{tableData:f,menu:c,setTableData:h}=T();return l("div",{className:`${r} h-12 flex justify-between items-center pt-2 `,children:[l("div",{className:" flex items-center pl-4 space-x-2 ",children:[t(q,{value:c==null?void 0:c.icon,readPretty:!0,className:" text-blue-500"}),t("span",{className:"font-bold text-base ",children:m}),p]}),t("div",{className:"flex items-center space-x-2 pr-4 ",children:e&&t(w,{activeKey:f.tabActiveKey,btns:[b?{title:"数据导入",allowEmpty:!0,actionType:"modal",sysMenuId:x,permissionCode:`${e==null?void 0:e.entityType}:save`,modal:t(z,{entityType:e==null?void 0:e.entityType}),onSubmitFinish:s=>{h(d=>({...d,loadDataFlag:d.loadDataFlag+1}))}}:null,...(i==null?void 0:i.map(s=>({...s,theme:"solid",sysMenuId:x,onSubmitFinish:s.onSubmitFinish?s.onSubmitFinish:d=>{h(n=>({...n,loadDataFlag:n.loadDataFlag+1}))}})))||[]].filter(s=>s!==null)||[]})})]})};export{L as T};
