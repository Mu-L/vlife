import{a0 as G,a as X,j as b,d as n,r as p,aA as le,g as K,a2 as ce,u as de,h as ue,F as Q,c as pe}from"./index-SxAtwMns.js";import{d as L}from"./types-0neFvap8.js";import{T as Y,a as Z,b as me}from"./Tabs-BmUND6bg.js";import{T as ye}from"./TableHeader-OVk3QsYD.js";import{h as fe,V as be,F as ee,u as he,B as M}from"./formPage-DEYoTnuZ.js";import{u as ge,B as U}from"./index-BLqHf6AC.js";import{S as W}from"./index-ubKoO-iZ.js";import{S as ve}from"./SortList-6VwlLzzW.js";import{G as te}from"./GroupButton-C-osmH_b.js";const xe=r=>G.delete("/sysTab/remove",{data:r}),Ge=r=>G.get(`/sysTabDto/detail/${r}`),Te=r=>G.post("/sysTabDto/list",r),Ke=r=>G.post("/sysTabDto/save",r),Ne=r=>G.post("/sysTab/sort",r),we=(r,C,h)=>(r.splice(h,0,r.splice(C,1)[0]),r),Ce=r=>{var I;const{tabs:C,onChange:h,className:y,modelId:$,sysMenuId:E}=r,S=X();return b("div",{children:[n("div",{className:" text-sm  text-gray-400 p-2",children:"上下拖拽进行排序"}),n(ve,{useDragHandle:!0,className:"  bg-gray-100",value:((I=C.sort((d,N)=>(d.sort||0)-(N.sort||0)))==null?void 0:I.map(d=>({id:d.id,name:d.title})))||[],onSortEnd:async({oldIndex:d,newIndex:N})=>{const x=we(C,d,N).map((a,T)=>({...a,sort:T}));Ne(x.map(a=>a.id)).then(a=>{h==null||h(x)})}}),$&&b("div",{onClick:()=>{S(`/full/tableViewConfig/${$}?sysMenuId=${E}`)},className:"mt-2 rounded border border-gray-600 space-x-4 cursor-pointer hover:bg-gray-50  border-dashed h-10 w-full flex items-center justify-center",children:[n("i",{className:" icon-add-member2 text-xl"}),n("div",{children:"创建视图"})]})]})},Se=r=>{const{className:C,formData:h,tableModel:y,btns:$,title:E,onClose:S}=r,[I,d]=p.useState(0),N=p.useRef(null);le(N);const[x,a]=p.useState(h),[T,B]=p.useState([]),[u,F]=K.useState();return p.useEffect(()=>{fe(y.entityType).then(i=>{var w,m;B(i.data||[]),F((m=(w=i.data)==null?void 0:w[0])==null?void 0:m.type)})},[y]),b("div",{className:`${C} flex flex-col h-full `,ref:N,children:[b("div",{className:" px-4 py-2",children:[b("div",{className:"flex h-12 w-full items-center !border-b   ",children:[n("div",{className:"font-bold text-xl p-3 text-center",children:E||y.title}),n(te,{className:"flex-1 justify-end",btns:$.map(i=>i.actionType==="edit"&&i.model===y.type?{...i,onSubmitFinish(w){a(w)}}:i.actionType==="create"&&i.model!==y.type?{...i,reaction:[...i.reaction||[],be.result((w,m)=>{var P;return((P=m==null?void 0:m.fields)==null?void 0:P.find(l=>l.fieldName===`${y.entityType}Id`))!==void 0}).then(`${y.entityType}Id`).value(x.id).readPretty()],onSubmitFinish(w){d(m=>m+1)}}:{...i})||[],datas:h}),n("div",{className:"w-20 justify-center flex",children:n(ce,{onClick:S,className:" cursor-pointer hover:text-blue-500"})})]}),n(ee,{terse:!0,modelInfo:y,modifyData:x,readPretty:!0})]}),b("div",{className:" flex  flex-1 flex-col   w-full ",children:[n(Y,{className:" w-full mb-2",activeKey:u,tabs:T.map(i=>({key:i.type,name:i.title})),onTabChange:i=>{F(i)}}),n(Z,{className:" flex-1",ignores:[`${y.entityType}Id`],req:{req:{[`${y.entityType}Id`]:x.id}},tableModel:T.find(i=>i.type===u)},u||""+I)]})]})},Be=r=>{const{title:C,conditionReq:h,listModelType:y,listModelId:$,searchFields:E,filterType:S,menu:I,superUser:d="pro",designTabDto:N,onFilterFormData:x}=r,{id:a}=I,T=X(),B=ge("formModal"),[u,F]=p.useState([]),[i,w]=K.useState(),{tableData:m,setTableData:P,user:l,btns:v,app:D}=de(),[se,O]=p.useState(!1),[_,R]=p.useState(),{model:e}=he($?{id:$}:{type:y}),[j,oe]=K.useState(),[ne,ie]=K.useState(),c=p.useMemo(()=>N||u.find(t=>t.id===i),[i,u,N]),z={title:"查看",actionType:"view",model:e==null?void 0:e.type},g=p.useMemo(()=>{var t,o;if(l!=null&&l.superUser)return(c==null?void 0:c.sysTabButtons)||[];if(l!=null&&l.sysUserGroup_sysGroup&&l.sysUserGroup_sysGroup.length>0){const s=((t=c==null?void 0:c.sysTabVisits)==null?void 0:t.filter(f=>f.sysGroupId&&f.visitButtonIds&&(l==null?void 0:l.sysUserGroup_sysGroup.some(V=>V.id==f.sysGroupId))).map(f=>f.visitButtonIds))||[];return((o=c==null?void 0:c.sysTabButtons)==null?void 0:o.filter(f=>s.some(V=>V.indexOf(f.buttonId)!==-1)))||[]}return[]},[c==null?void 0:c.sysTabButtons,l]),H=p.useMemo(()=>{const t=g==null?void 0:g.filter(o=>o.buttonId&&o.buttonPosition==="tableLine").sort((o,s)=>(o.buttonSort||0)-(s.buttonSort||0)).map(o=>o.buttonId);return[...(t==null?void 0:t.map(o=>v==null?void 0:v.find(s=>s.id===o)).filter(o=>!!o).map(o=>({...L(o,l,e==null?void 0:e.type),sysMenuId:a})))||[],z]},[v,g,l,e==null?void 0:e.type,z]),ae=p.useMemo(()=>{const t={};return e==null||e.fields.filter(o=>o.entityType!==e.entityType).forEach(o=>{t[o.fieldName]=s=>{B.show({type:o.entityType,formData:s,readPretty:!0})}}),t},[e]),A=p.useMemo(()=>{var o;const t=g==null?void 0:g.filter(s=>s.buttonId&&s.buttonPosition==="tableToolbar").map(s=>s.buttonId);return((o=t==null?void 0:t.map(s=>v==null?void 0:v.find(f=>f.id===s)).filter(s=>!((s==null?void 0:s.actionType)==="create"&&s.model===(e==null?void 0:e.type))).filter(s=>!!s))==null?void 0:o.map(s=>({...L(s,l,e==null?void 0:e.type),sysMenuId:a})))||[]},[v,g,e==null?void 0:e.type,l]),q=p.useMemo(()=>{var o;const t=(o=g==null?void 0:g.filter(s=>s.buttonId&&s.buttonPosition==="tableToolbar"))==null?void 0:o.map(s=>s.buttonId);return(t==null?void 0:t.map(s=>v==null?void 0:v.find(f=>f.id===s)).filter(s=>(s==null?void 0:s.actionType)==="create"&&s.model&&s.model===(e==null?void 0:e.type)).map(s=>({...L(s,l,e==null?void 0:e.type),theme:"solid",sysMenuId:a})))||[]},[A,l,g,e==null?void 0:e.type]),re=p.useMemo(()=>{let t={orAnd:"and",where:[],conditions:[]};return h&&(t=ue(h)),j&&(t={...t,conditions:[...t.conditions,j]}),t},[h,j,c,I]),J=p.useCallback(async()=>{if(a)return Te({req:{sysMenuId:a}}).then(t=>{var o,s;F(t.data||[]),w((s=(o=t.data)==null?void 0:o.sort((f,V)=>f.sort-V.sort))==null?void 0:s[0].id)})},[a]),k=p.useMemo(()=>u.length===1?[]:(u==null?void 0:u.sort((t,o)=>t.sort-o.sort).map(t=>({name:t.title,key:t.id,icon:t.icon,conditions:{orAnd:"and",where:[],conditions:[]}})))||[],[u]);return p.useEffect(()=>{J()},[a]),c?b("div",{className:" flex flex-col h-full bg-slate-50 ",children:[e&&a&&d!=="design"&&n(ye,{className:" border-t  w-full bg-white shadow",btns:q,label:C||I.name||e.title,sysMenuId:a,model:e,children:d===!0&&b("div",{className:"flex space-x-1 items-center",children:[n(U,{tooltip:"表单配置",btnType:"icon",allowEmpty:!0,icon:n("i",{className:" icon-build text-gray-500  hover:bg-gray-200 hover:text-blue-500 p-1 rounded-md cursor-pointer"}),actionType:"click",onClick:()=>{T(`/full/formDesign/${e==null?void 0:e.id}`)}}),(!k||k.length<=1)&&(D==null?void 0:D.appKey)!=="sys"&&n(M,{btns:[{title:"添加新的视图",icon:n("i",{className:"icon-task_add-02 font-bold hover:bg-gray-200 hover:text-blue-500 p-1 rounded-md cursor-pointer"}),btnType:"icon",allowEmpty:!0,actionType:"click",onClick:()=>{T(`/full/tableViewConfig/${e.id}?sysMenuId=${a}`)}}]})]})},e.id),k&&k.length>0&&e&&d!=="design"&&n(Y,{superUser:d,activeKey:i,tabs:k||[],tabBtn:d===!0&&n(M,{dropdown:n("i",{className:"icon-arrow-down-border"}),btns:[{title:"编辑视图",actionType:"click",btnColor:"tertiary",theme:"borderless",allowEmpty:!0,onClick:()=>{T(`/full/tableViewConfig/${e.id}?sysTabId=${i}`)}},{title:"删除视图",actionType:"api",saveApi:xe,multiple:!0,datas:u==null?void 0:u.find(t=>{var o;return t.id===(m.tabActiveKey||((o=k==null?void 0:k[0])==null?void 0:o.key))}),onSubmitFinish:t=>{J()}}]}),onTabChange:t=>{w(t),P(o=>({...o,tabActiveKey:t,selected:[]}))},children:d===!0&&(D==null?void 0:D.appKey)!=="sys"&&b(Q,{children:[n(U,{title:"添加新的视图",actionType:"click",onClick:()=>{T(`/full/tableViewConfig/${e.id}?sysMenuId=${a}`)},allowEmpty:!0,icon:n("i",{className:"icon-task_add-02 font-bold"}),btnType:"icon"}),((u==null?void 0:u.length)||0)>1&&b(Q,{children:[n(U,{title:"视图排序",actionType:"click",onClick:()=>{O(!0)},allowEmpty:!0,icon:n("i",{className:" icon-table_rows"}),btnType:"icon"}),n(W,{title:"视图",visible:se,onCancel:()=>O(!1),closeOnEsc:!0,children:n(Ce,{sysMenuId:a,modelId:e.id,tabs:u,onChange:F})})]})]})}),b("div",{className:"flex flex-1 w-full px-2 mt-2 bg-slate-50 space-x-2 ",children:[S&&n(ee,{className:"w-60 bg-white p-4 rounded border h-full",type:S,fontBold:!1,onChange:t=>{ie({...t}),x==null||x({...t})}}),b("div",{className:`flex flex-col ${pe({"flex-1 overflow-hidden":S!==void 0,"w-full":S===void 0})}`,children:[e&&c&&n(me,{className:"w-full h-10 rounded-t-xl border bg-white ",leftBtns:A&&A.length>0?n(te,{position:"tableToolbar",activeKey:m.tabActiveKey,btns:A.map(t=>({...t,theme:"borderless",onSubmitFinish:t.onSubmitFinish||(o=>{P(s=>({...s,selected:[],loadDataFlag:s.loadDataFlag+1}))})})),datas:m==null?void 0:m.selected}):d==="design"&&A.length===0&&q.length===0?b("span",{className:"  text-sm",children:["请在右侧[",n("span",{className:" text-red-500",children:"按钮配置"}),"]栏添加按钮"]}):void 0,tableModel:e,searchFields:E,rightBtns:d==="design"?q:[],onSearchChange:oe,children:d===!0&&n(M,{btns:[{title:"视图配置",icon:n("i",{className:" icon-build text-gray-500  hover:bg-gray-200 hover:text-blue-500 p-1 rounded-md cursor-pointer"}),tooltip:"视图配置",actionType:"click",btnColor:"tertiary",theme:"borderless",btnType:"icon",allowEmpty:!0,onClick:()=>{T(`/full/tableViewConfig/${e.id}?sysMenuId=${a}&sysTabId=${i}`)}}]})}),e&&c&&c.sysMenuId===a&&n(Z,{sysTabDto:c,className:"flex flex-1 border-b border-x bg-white",tableModel:e,req:{...ne,conditions:re},btns:H,onFieldClick:ae,onLineClick:c.formShowType==="relation_subs"?t=>{R(t)}:void 0}),n(W,{headerStyle:{padding:"0px",zIndex:10},bodyStyle:{padding:"0px"},visible:!!_,width:1200,closable:!1,onCancel:()=>{R(void 0)},closeOnEsc:!0,children:n(Se,{tableModel:e,formData:_,onClose:()=>R(void 0),className:" p-2 bg-gray-50 ",btns:H})})]})]})]}):n("div",{className:"  justify-center flex items-center  text-red-400",children:"当前没有任何视图"})};export{Be as P,Ke as a,Ge as s};
