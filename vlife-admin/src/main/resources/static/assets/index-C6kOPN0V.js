import{d as t,j as u,r as x,a as G,B as R,g as T,b as $,u as O,ao as U,ap as k,c as A}from"./index-ClvCGvy-.js";import{F as _}from"./FullScreenHeader-MixJTueS.js";import{G as q,F as M,V as N,u as L,k as W}from"./formPage-D8ezj0WE.js";import{s as D,P as H,a as J}from"./ProTable-Bh7_QKow.js";import{B as S,h as z}from"./index-BxbY9JGq.js";import{C as j,b as I}from"./index-Wlwe5g9P.js";import{S as E}from"./SortList-gr_fFUUf.js";import{G as Y}from"./GroupButton-lOBvLqtf.js";import{S as K}from"./index-BY9_IzkV.js";import"./toInteger-DzTPojnH.js";import"./index-p5CuCj6W.js";import"./index-C5OWF-D0.js";import"./types-CtYXSVtD.js";import"./Tabs-CTns7yZQ.js";import"./static-wPmgQVRS.js";import"./TableHeader-CBn3u5no.js";import"./index-BCvCVhRJ.js";const Q=({groups:s,onChange:r})=>t("div",{className:" w-full h-full",children:t(j,{type:"card",direction:"vertical",onChange:r,children:s.map(c=>t(I,{value:c.id,extra:c.remark,style:{width:280},children:c.name},c.id))})}),X=({className:s,value:r,groups:c,buttonIds:e,onChange:a,label:o})=>{var f;return u("div",{className:`${s} w-full  justify-center flex flex-col space-y-2 pb-2 `,children:[t("div",{className:" font-semibold  text-sm ",children:o}),t("div",{className:" flex flex-col justify-center w-full ",children:t(S,{className:" w-full",formTitle:"关联权限组",actionType:"modal",modal:t(Q,{groups:c.filter(i=>!(r!=null&&r.map(d=>d.sysGroupId).includes(i.id)))}),allowEmpty:!0,submitClose:!0,saveApi:i=>{i&&(a==null||a([...r||[],...i.map(d=>({sysGroupId:d,visitButtonIds:e}))]))},children:u("div",{className:"border w-full bg-white h-10 flex items-center justify-center  hover:bg-gray-100 cursor-pointer ",children:[t("span",{className:" mr-4",children:t("i",{className:" icon-create-network"})}),t("span",{children:"关联权限组"})]})})}),!r||r.length===0?t("div",{className:"p-2 text-center text-gray-400  text-sm ",children:t("span",{className:" text-red-500 px-2",children:"* 请选择至少一个权限组"})}):u("div",{className:"   bg-gray-100 p-2 justify-center  flex flex-col space-y-2 ",children:[(f=r.filter(i=>i.sysDeptId||i.sysGroupId||i.sysUserId))==null?void 0:f.map((i,d)=>{var n;return u("div",{className:"border text-sm bg-white group h-8 w-full rounded-sm flex items-center relative space-x-2 px-4 hover:bg-orange-100 cursor-pointer  ",children:[u("span",{children:[d+1,"."]}),t("span",{className:" text-sm ",children:(n=c.find(l=>(l==null?void 0:l.id)===(i==null?void 0:i.sysGroupId)))==null?void 0:n.name}),t("div",{className:" absolute right-2 hidden group-hover:block text-xs",onClick:()=>{a(r.filter((l,m)=>m!==d))},children:t("i",{className:" icon-custom_-page_delete text-xl  mr-4 group-hover:block hidden  cursor-pointer"})})]},d)}),t("div",{className:" text-center text-sm text-gray-400 ",children:"当前视图向以上权限组用户开放"})]})]})},Z=s=>{const{allGroups:r,tabButtons:c,value:e,onChange:a,label:o,className:f=""}=s;return u("div",{className:`${f} w-full  justify-center flex flex-col space-y-2 pb-2 `,children:[t("div",{className:" font-semibold  text-sm ",children:o}),e==null?void 0:e.map(i=>{var d,n;return u("div",{className:"flex flex-col space-y-1",children:[t(q,{text:((d=r.find(l=>l.id===i.sysGroupId))==null?void 0:d.name)||""}),t("div",{className:"flex flex-wrap pl-4",children:t(j,{defaultValue:(n=i.visitButtonIds)==null?void 0:n.split(","),direction:"horizontal",onChange:l=>{a==null||a(e.map(m=>i.id===m.id?{...m,visitButtonIds:l.join(",")}:m))},children:c.map(l=>t(I,{value:l.id,children:l.title},l.id))})})]},i.id)})]})},v=({value:s,groups:r,onChange:c,buttonVo:e,className:a=""})=>{const[o,f]=x.useState(s||{});return x.useEffect(()=>{c==null||c(o)},[o]),u("div",{className:`${a} flex flex-1 flex-col`,children:[t(M,{className:" w-full",terse:!0,fontBold:!0,type:"sysTabDto",reaction:[N.then("title").required(),N.then("entityId","sort","conditionJson","dataLevel","orderType","sysMenuId","viewType","orderDirection","orderFieldName","icon","fieldNames","sysTabButtons","sysTabVisits","formShowType").hide()],formData:{...s,formShowType:(s==null?void 0:s.formShowType)||"single_table"},onChange:i=>{f(d=>({...s,...i,sysTabVisits:d.sysTabVisits||[]}))}},s==null?void 0:s.id),t(X,{className:" w-full",label:"访问授权",value:(s==null?void 0:s.sysTabVisits)||[],buttonIds:e==null?void 0:e.map(i=>i.id).join(","),onChange:i=>{f(d=>({...s,sysTabVisits:i}))},groups:r}),e&&e.length>0&&(s==null?void 0:s.sysTabVisits)&&(s==null?void 0:s.sysTabVisits.length)>0&&t(Z,{className:"   ",allGroups:r,label:"操作授权",value:s.sysTabVisits,tabButtons:e,onChange:i=>{f(d=>({...s,sysTabVisits:i}))}}),s&&s.sysTabVisits&&s.sysTabVisits.length>0&&(!e||e.length===0&&t("div",{className:"text-red-500 flex justify-center w-full m-2 text-sm",children:"未配置按钮，视图只读"}))]})},C=({value:s,onChange:r})=>t(M,{className:" w-full",fontBold:!0,terse:!0,type:"sysTabDto",reaction:[N.then("title","orderFieldName","orderDirection","orderType","formShowType","entityId","sysMenuId","sort","viewType","icon","sysTabFields","sysTabButtons","sysTabVisits","fieldNames").hide()],formData:s,onChange:c=>{r==null||r({...s,...c})}},s==null?void 0:s.id),ee=({buttons:s,onChange:r,formId:c})=>{const e=G();return u("div",{className:" w-full h-full relative",children:[s&&s.length>0?t(j,{type:"card",direction:"vertical",onChange:r,children:s.map(a=>t(I,{value:a.id,extra:a.tooltip,style:{width:280},children:a.title},a.id))}):t("div",{className:" text-red-500 w-full h-full items-center",children:"该场景下支持的按钮已经全部导入"}),c&&t(R,{theme:"borderless",className:" absolute right-0 top-0",onClick:()=>{e(`/full/advSetting/${c}?tab=3`)},children:"添加自定义按钮"})]})},V=({className:s,value:r,position:c,buttons:e,onChange:a,formId:o,label:f})=>{var n;const i=(l,m,h)=>(l.splice(h,0,l.splice(m,1)[0]),l),d=G();return u("div",{className:`${s} w-full rounded  justify-center flex flex-col  pb-2 `,children:[u("div",{className:" flex  pb-2 justify-between",children:[u("div",{className:"font-semibold text-sm ",children:[f,"(",r==null?void 0:r.length,")"]}),t("a",{className:"flex  text-sm text-blue-500",href:"#",onClick:()=>{d(`/full/advSetting/${o}?tab=3`)},children:"按钮配置"})]}),t("div",{className:" flex flex-col justify-center w-full mb-2",children:t(S,{className:" w-full",formTitle:"关联按钮",actionType:"modal",modal:t(ee,{formId:o,buttons:e.filter(l=>!(r!=null&&r.map(m=>m.buttonId).includes(l.id)))}),allowEmpty:!0,submitClose:!0,saveApi:l=>{a==null||a([...r||[],...l.map(m=>({buttonId:m,buttonPosition:c}))])},children:u("div",{className:"border w-full rounded border-dashed bg-white h-10 flex items-center justify-center  hover:bg-gray-100 cursor-pointer ",children:[t("span",{className:" mr-4",children:t("i",{className:" icon-create-network"})}),t("span",{className:" text-sm",children:"添加按钮"})]})})}),!r||r.length===0?t("div",{className:"p-2 text-center text-gray-400  text-sm ",children:"暂未配置按钮"}):t(E,{useDragHandle:!0,className:"  bg-gray-100 p-2",value:((n=r.sort((l,m)=>(l.buttonSort||0)-(m.buttonSort||0)))==null?void 0:n.map(l=>{var m,h;return{id:l.buttonId,name:t(S,{theme:"borderless",title:(m=e.find(b=>b.id===l.buttonId))==null?void 0:m.title,allowEmpty:!0,icon:(h=e.find(b=>b.id===l.buttonId))==null?void 0:h.icon})}}))||[],onRemove:l=>{a==null||a(r.filter(m=>m.buttonId!==l))},onSortEnd:({oldIndex:l,newIndex:m})=>{a==null||a(i(r,l,m).map((h,b)=>({...h,buttonSort:b})))}})]})},te=({value:s,onChange:r,buttons:c,formId:e})=>{const{model:a}=L({id:e}),o=T.useMemo(()=>(s||[]).filter(n=>n.buttonPosition==="tableToolbar"),[s]),f=T.useMemo(()=>(s||[]).filter(n=>n.buttonPosition==="tableLine"),[s]),i=T.useMemo(()=>c.filter(n=>{var m,h;const l=((m=n.sysResources)==null?void 0:m.paramWrapper.indexOf("[]"))!==-1||((h=n.sysResources)==null?void 0:h.paramWrapper)==="List";return n.actionType==="create"||l}).filter(n=>!f.map(l=>l.buttonId).includes(n.id)),[c,f]),d=T.useMemo(()=>c.filter(n=>{var m,h;const l=((m=n.sysResources)==null?void 0:m.paramWrapper.indexOf("[]"))!==-1||((h=n.sysResources)==null?void 0:h.paramWrapper)==="List";return n.actionType==="edit"||n.actionType==="create"&&(a==null?void 0:a.type)&&n.model!==a.type||n.actionType!=="create"&&!l}).filter(n=>!o.map(l=>l.buttonId).includes(n.id)),[c,o,a]);return u("div",{className:"w-full space-y-2",children:[t(V,{label:"工具栏顶部按钮",formId:e,value:o,buttons:i,onChange:n=>{r==null||r([...(s||[]).filter(l=>l.buttonPosition!=="tableToolbar"),...n||[]])},position:"tableToolbar"}),t(V,{label:"数据详情按钮",formId:e,value:f,buttons:d,onChange:n=>{r==null||r([...(s||[]).filter(l=>l.buttonPosition!=="tableLine"),...n||[]])},position:"tableLine"})]})},se=({value:s,data:r,onChange:c,className:e})=>t("div",{className:`${e} grid grid-cols-4 space-y-1`,children:r.filter(a=>a.fieldName!=="id").map(a=>t(I,{className:"flex items-center space-x-2 text-sm",checked:s==null?void 0:s.includes(a.fieldName),onChange:()=>{c==null||c(s!=null&&s.includes(a.fieldName)?s.filter(o=>o!==a.fieldName):[...s||[],a.fieldName])},children:a.title},a.id))}),ie=({className:s,label:r,value:c,model:e,onChange:a})=>{x.useState();const[o,f]=x.useState(c?c.split(","):e.fields.filter(i=>i.fieldName!=="id").sort((i,d)=>i.sort-d.sort).map(i=>i.fieldName));return z(()=>{a(o==null?void 0:o.join(","))},[o]),u("div",{className:`${s} w-full justify-center flex flex-col space-y-2 pb-2 `,children:[t("div",{className:" font-semibold  text-sm",children:r}),t("div",{className:" flex flex-col justify-center w-full ",children:t(S,{className:" w-full",formTitle:"添加字段",actionType:"modal",modal:t(se,{data:e.fields,value:o,onChange:i=>{alert(i)}}),allowEmpty:!0,submitClose:!0,saveApi:i=>{f(i)},children:t("div",{className:" w-full  items-center flex ",children:u("div",{className:"border bg-white h-10 w-full rounded  flex items-center justify-center hover:border-dashed hover:border-gray-500  hover:bg-gray-100 cursor-pointer ",children:[t("span",{className:" mr-4",children:t("i",{className:" icon-create-network"})}),t("span",{className:"text-sm text-gray-700",children:"添加字段"})]})})})}),o&&o.length>0?t(E,{useDragHandle:!0,className:"p-2  bg-gray-100",value:(o==null?void 0:o.map(i=>{var d,n;return{id:i,name:(d=e.fields.find(l=>l.fieldName===i))==null?void 0:d.title,subName:(n=e.fields.find(l=>l.fieldName===i))==null?void 0:n.fieldName}}))||[],onRemove:i=>{f(d=>d==null?void 0:d.filter(n=>n!==i))},onSortEnd:({oldIndex:i,newIndex:d})=>{f(n=>{const l=Array.from(n);return l.splice(d,0,l.splice(i,1)[0]),l})}}):t("div",{className:" text-red-500 text-sm text-center",children:"请至少选择一个字段在列表进行展示"})]})},re=({value:s,menuModel:r,onChange:c})=>u("div",{className:" h-full flex flex-col",children:[t(M,{fontBold:!0,terse:!0,className:"",type:"sysTabDto",reaction:[N.then("conditionJson","dataLevel","title","sort","formShowType","entityId","sysMenuId","viewType","icon","sysTabButtons","fieldNames","sysTabVisits").hide(),N.field("orderType").eq("CUSTOM").then("orderFieldName","orderDirection").show().required(),N.field("orderType").ne("CUSTOM").then("orderFieldName","orderDirection").clearValue()],formData:s,onChange:e=>{c({...s,...e})}},s==null?void 0:s.id),t(ie,{className:"",model:r,value:s==null?void 0:s.fieldNames,label:"视图显示字段",onChange:e=>{c({...s,fieldNames:e})}})]}),Se=()=>{const{pathname:s}=$(),r=s.split("/").pop(),c=new URLSearchParams(window.location.search),[e,a]=x.useState(),o=c.get("sysTabId"),f=c.get("sysMenuId")||void 0,{model:i}=L({id:r}),[d,n]=x.useState(),[l,m]=x.useState([]),{user:h}=O();x.useEffect(()=>{i&&(o?D(o).then(p=>{a(p.data)}):a({entityId:i.entityId,title:"新建视图",sysMenuId:f,dataLevel:"1",viewType:"table",orderType:"SYS"}))},[o,f,i]),x.useEffect(()=>{r&&(f||e!=null&&e.sysMenuId)&&!d&&U({conditions:{orAnd:"or",where:[{fieldName:"resourcesEntityId",opt:k.eq,value:[r]},{fieldName:"sysMenuId",opt:k.eq,value:[f||(e==null?void 0:e.sysMenuId)]}]}}).then(p=>{n([...p.data||[]])}),W().then(p=>{m(p.data||[])})},[r,f,e==null?void 0:e.sysMenuId,d]);const b=[{label:"基础信息",icon:t("i",{className:"icon-calendar-abstract"})},{label:"数据展示",icon:t("i",{className:"icon-view_eye"})},{label:"数据权限",icon:t("i",{className:" icon-role-approval2"})},{label:"按钮配置",icon:t("i",{className:"  icon-smart_button_black_24dp"})}],[w,F]=x.useState(0),g=x.useMemo(()=>{var y;const p=[];return e!=null&&e.title||p.push("视图名称不能为空"),(e==null?void 0:e.orderType)==="CUSTOM"&&(!e.orderDirection||!e.orderFieldName)&&p.push("自定义排序的字段和方向不能为空"),(e==null?void 0:e.dataLevel)==="CUSTOM"&&(!e.conditionJson||e.conditionJson==="[]")&&p.push("请在[数据权限]里配置至少一个条件筛选规则"),!(e!=null&&e.sysTabVisits)||((y=e==null?void 0:e.sysTabVisits)==null?void 0:y.length)===0?p.push("请至少授权一个角色组访问此视图"):(e==null||e.sysTabVisits.filter(B=>!B.visitButtonIds).length,e==null||e.sysTabVisits.length),p},[e]),P=h==null?void 0:h.menus.find(p=>p.id===f);return t(_,{title:(e==null?void 0:e.title)||"新建视图",children:u("div",{className:"flex h-full  bg-slate-50",children:[t("div",{className:" flex-1 h-full flex flex-col  px-2 pt-2 overflow-hidden",children:i&&e&&t(H,{menu:P||{id:e.sysMenuId},designTabDto:e,superUser:"design",listModelId:i==null?void 0:i.id})}),u("div",{style:{width:"430px"},className:"  flex flex-col border-l bg-white h-full ",children:[u("div",{className:" flex w-full   ",children:[t("span",{className:"text-base px-6 py-2 font-semibold h-12",children:"视图配置"}),t("span",{className:" flex flex-1 items-center text-red-500 text-sm"})]}),u("div",{className:"flex flex-1",children:[t("div",{style:{width:"125px"},className:"border-r flex flex-col px-2 items-center  space-y-1",children:b.map((p,y)=>u("div",{onClick:()=>F(y),className:`w-full ${A({" bg-gray-100 font-semibold !text-black ":w===y})} hover:bg-gray-100 cursor-pointer hover:text-gray-800 text-gray-500 text-sm px-2 space-x-2 h-9 font-chinese rounded-md flex justify-center items-center`,children:[t("div",{children:p.icon}),t("div",{children:p.label})]},y))}),t("div",{id:"rightMain",className:"flex-1 pl-2 pr-4 flex flex-col ",children:t(K,{autoHide:!0,children:u("div",{className:" mx-2",children:[w===0&&e&&t(v,{className:"",groups:l,value:e,buttonVo:(d==null?void 0:d.filter(p=>{var y;return(y=e.sysTabButtons)==null?void 0:y.some(B=>B.buttonId===p.id)}))||[],onChange:p=>{a(p)}}),w===1&&i&&e&&t(re,{menuModel:i,value:e,onChange:a}),w===2&&e&&t(C,{value:e,onChange:a}),w===3&&e&&t(te,{buttons:d||[],formId:r,value:(e==null?void 0:e.sysTabButtons)||[],onChange:p=>{a(y=>({...y||{},sysTabButtons:p}))}})]})})})]}),t("div",{className:" p-4 text-base  h-20 space-x-4 flex items-center border-t ",children:t(Y,{btns:[{title:"保存",theme:"solid",actionType:"edit",modalOpen:!0,datas:e,usableMatch:()=>g.length>0?g[0]:!0,saveApi:()=>{g.length===0&&e&&J(e).then(p=>{a(p.data)})}}]})})]})]})})};export{Se as default};
