import{d as t,j as p,r as x,a as M,B as $,g as w,b as O,u as U,af as q,ag as V,c as A}from"./index-BNDtW2eT.js";import{F as _}from"./FullScreenHeader-CJVaJaq3.js";import{G as H,F as j,V as N,u as G,t as W}from"./formPage-BHPYqPSB.js";import{s as D,P as J,a as z}from"./ProTable-DXqSSh_w.js";import{h as k,i as S,B as T,q as Y}from"./index-C6DPW6pI.js";import{S as L}from"./SortList-BOTT_UqL.js";import{G as K}from"./GroupButton-D5eFJVxs.js";import{S as Q}from"./index-BGJ_SIlp.js";import"./index-B-XWCHoo.js";import"./index-DQz7rEVH.js";import"./types-VhQTFa8D.js";import"./Tabs-8Y1H_XcO.js";import"./useEffectWithTarget-aARMLXxS.js";import"./TableHeader-OG3ax13l.js";import"./index-CXoj0GaU.js";const X=({groups:s,onChange:l})=>t("div",{className:" w-full h-full",children:t(k,{type:"card",direction:"vertical",onChange:l,children:s.map(n=>t(S,{value:n.id,extra:n.remark,style:{width:280},children:n.name},n.id))})}),Z=({className:s,value:l,groups:n,buttonIds:d,onChange:e,label:o})=>{var f;return p("div",{className:`${s} w-full  justify-center flex flex-col space-y-2 pb-2 `,children:[t("div",{className:" font-semibold  text-sm ",children:o}),t("div",{className:" flex flex-col justify-center w-full ",children:t(T,{className:" w-full",formTitle:"关联权限组",actionType:"modal",modal:t(X,{groups:n.filter(r=>!(l!=null&&l.map(c=>c.sysGroupId).includes(r.id)))}),allowEmpty:!0,submitClose:!0,saveApi:r=>{r&&(e==null||e([...l||[],...r.map(c=>({sysGroupId:c,visitButtonIds:d}))]))},children:p("div",{className:"border w-full bg-white h-10 flex items-center justify-center  hover:bg-gray-100 cursor-pointer ",children:[t("span",{className:" mr-4",children:t("i",{className:" icon-create-network"})}),t("span",{children:"关联权限组"})]})})}),!l||l.length===0?t("div",{className:"p-2 text-center text-gray-400  text-sm ",children:t("span",{className:" text-red-500 px-2",children:"* 请选择至少一个权限组"})}):p("div",{className:"   bg-gray-100 p-2 justify-center  flex flex-col space-y-2 ",children:[(f=l.filter(r=>r.sysDeptId||r.sysGroupId||r.sysUserId))==null?void 0:f.map((r,c)=>{var i;return p("div",{className:"border text-sm bg-white group h-8 w-full rounded-sm flex items-center relative space-x-2 px-4 hover:bg-orange-100 cursor-pointer  ",children:[p("span",{children:[c+1,"."]}),t("span",{className:" text-sm ",children:(i=n.find(a=>(a==null?void 0:a.id)===(r==null?void 0:r.sysGroupId)))==null?void 0:i.name}),t("div",{className:" absolute right-2 hidden group-hover:block text-xs",onClick:()=>{e(l.filter((a,u)=>u!==c))},children:t("i",{className:" icon-custom_-page_delete text-xl  mr-4 group-hover:block hidden  cursor-pointer"})})]},c)}),t("div",{className:" text-center text-sm text-gray-400 ",children:"当前视图向以上权限组用户开放"})]})]})},v=s=>{const{allGroups:l,tabButtons:n,value:d,onChange:e,label:o,className:f=""}=s;return p("div",{className:`${f} w-full  justify-center flex flex-col space-y-2 pb-2 `,children:[t("div",{className:" font-semibold  text-sm ",children:o}),d==null?void 0:d.map(r=>{var c,i;return p("div",{className:"flex flex-col space-y-1",children:[t(H,{text:((c=l.find(a=>a.id===r.sysGroupId))==null?void 0:c.name)||""}),t("div",{className:"flex flex-wrap pl-4",children:t(k,{defaultValue:(i=r.visitButtonIds)==null?void 0:i.split(","),direction:"horizontal",onChange:a=>{e==null||e(d.map(u=>r.id===u.id?{...u,visitButtonIds:a.join(",")}:u))},children:n.map(a=>t(S,{value:a.id,children:a.title},a.id))})})]},r.id)})]})},C=({value:s,groups:l,onChange:n,buttonVo:d,className:e=""})=>{const[o,f]=x.useState(s||{});return x.useEffect(()=>{n==null||n(o)},[o]),p("div",{className:`${e} flex flex-1 flex-col`,children:[t(j,{className:" w-full",terse:!0,fontBold:!0,type:"sysTabDto",reaction:[N.then("title").required(),N.then("formId","sort","conditionJson","dataLevel","orderType","sysMenuId","viewType","orderDirection","orderFieldName","icon","fieldNames","sysTabButtons","sysTabVisits","formShowType").hide()],formData:{...s,formShowType:(s==null?void 0:s.formShowType)||"single_table"},onChange:r=>{f(c=>({...s,...r,sysTabVisits:c.sysTabVisits||[]}))}},s==null?void 0:s.id),t(Z,{className:" w-full",label:"访问授权",value:(s==null?void 0:s.sysTabVisits)||[],buttonIds:d==null?void 0:d.map(r=>r.id).join(","),onChange:r=>{f(c=>({...s,sysTabVisits:r}))},groups:l}),d&&d.length>0&&(s==null?void 0:s.sysTabVisits)&&(s==null?void 0:s.sysTabVisits.length)>0&&t(v,{className:"   ",allGroups:l,label:"操作授权",value:s.sysTabVisits,tabButtons:d,onChange:r=>{f(c=>({...s,sysTabVisits:r}))}}),s&&s.sysTabVisits&&s.sysTabVisits.length>0&&(!d||d.length===0&&t("div",{className:"text-red-500 flex justify-center w-full m-2 text-sm",children:"未配置按钮，视图只读"}))]})},ee=({value:s,onChange:l})=>t(j,{className:" w-full",fontBold:!0,terse:!0,type:"sysTabDto",reaction:[N.then("title","orderFieldName","orderDirection","orderType","formShowType","formId","sysMenuId","sort","viewType","icon","sysTabFields","sysTabButtons","sysTabVisits","fieldNames").hide()],formData:s,onChange:n=>{l==null||l({...s,...n})}},s==null?void 0:s.id),te=({buttons:s,onChange:l,formId:n})=>{const d=M();return p("div",{className:" w-full h-full relative",children:[s&&s.length>0?t(k,{type:"card",direction:"vertical",onChange:l,children:s.map(e=>t(S,{value:e.id,extra:e.tooltip,style:{width:280},children:e.title},e.id))}):t("div",{className:" text-red-500 w-full h-full items-center",children:"该场景下支持的按钮已经全部导入"}),n&&t($,{theme:"borderless",className:" absolute right-0 top-0",onClick:()=>{d(`/full/advSetting/${n}?tab=3`)},children:"添加自定义按钮"})]})},E=({className:s,value:l,position:n,buttons:d,onChange:e,formId:o,label:f})=>{var c;const r=(i,a,u)=>(i.splice(u,0,i.splice(a,1)[0]),i);return M(),p("div",{className:`${s} w-full rounded  justify-center flex flex-col  pb-2 `,children:[t("div",{className:" flex  pb-2 justify-between",children:p("div",{className:"font-semibold text-sm ",children:[f,"(",l==null?void 0:l.length,")"]})}),t("div",{className:" flex flex-col justify-center w-full mb-2",children:t(T,{className:" w-full",formTitle:"关联按钮",actionType:"modal",modal:t(te,{formId:o,buttons:d.filter(i=>!(l!=null&&l.map(a=>a.buttonId).includes(i.id)))}),allowEmpty:!0,submitClose:!0,saveApi:i=>{e==null||e([...l||[],...i.map(a=>({buttonId:a,buttonPosition:n}))])},children:p("div",{className:"border w-full rounded border-dashed bg-white h-10 flex items-center justify-center  hover:bg-gray-100 cursor-pointer ",children:[t("span",{className:" mr-4",children:t("i",{className:" icon-create-network"})}),t("span",{className:" text-sm",children:"添加按钮"})]})})}),!l||l.length===0?t("div",{className:"p-2 text-center text-gray-400  text-sm ",children:"暂未配置按钮"}):t(L,{useDragHandle:!0,className:"  bg-gray-100 p-2",value:((c=l.sort((i,a)=>(i.buttonSort||0)-(a.buttonSort||0)))==null?void 0:c.map(i=>{var a,u;return{id:i.buttonId,name:t(T,{theme:"borderless",title:(a=d.find(h=>h.id===i.buttonId))==null?void 0:a.title,allowEmpty:!0,icon:(u=d.find(h=>h.id===i.buttonId))==null?void 0:u.icon})}}))||[],onRemove:i=>{e==null||e(l.filter(a=>a.buttonId!==i))},onSortEnd:({oldIndex:i,newIndex:a})=>{e==null||e(r(l,i,a).map((u,h)=>({...u,buttonSort:h})))}})]})},se=({value:s,onChange:l,buttons:n,formId:d})=>{const{model:e}=G({id:d}),o=w.useMemo(()=>(s||[]).filter(i=>i.buttonPosition==="tableToolbar"),[s]),f=w.useMemo(()=>(s||[]).filter(i=>i.buttonPosition==="tableLine"),[s]),r=w.useMemo(()=>n.filter(i=>{var u,h;const a=((u=i.sysResources)==null?void 0:u.paramWrapper.indexOf("[]"))!==-1||((h=i.sysResources)==null?void 0:h.paramWrapper)==="List";return i.actionType==="create"||a}).filter(i=>!f.map(a=>a.buttonId).includes(i.id)),[n,f]),c=w.useMemo(()=>n.filter(i=>{var u,h;const a=((u=i.sysResources)==null?void 0:u.paramWrapper.indexOf("[]"))!==-1||((h=i.sysResources)==null?void 0:h.paramWrapper)==="List";return i.actionType==="edit"||i.actionType==="create"&&(e==null?void 0:e.type)&&i.model!==e.type||i.actionType!=="create"&&!a}).filter(i=>!o.map(a=>a.buttonId).includes(i.id)),[n,o,e]);return p("div",{className:"w-full space-y-2",children:[t(E,{label:"工具栏顶部按钮",formId:d,value:o,buttons:r,onChange:i=>{l==null||l([...(s||[]).filter(a=>a.buttonPosition!=="tableToolbar"),...i||[]])},position:"tableToolbar"}),t(E,{label:"数据详情按钮",formId:d,value:f,buttons:c,onChange:i=>{l==null||l([...(s||[]).filter(a=>a.buttonPosition!=="tableLine"),...i||[]])},position:"tableLine"})]})},ie=({value:s,data:l,onChange:n,className:d})=>t("div",{className:`${d} grid grid-cols-4 space-y-1`,children:l.filter(e=>e.fieldName!=="id").map(e=>t(S,{className:"flex items-center space-x-2 text-sm",checked:s==null?void 0:s.includes(e.fieldName),onChange:()=>{n==null||n(s!=null&&s.includes(e.fieldName)?s.filter(o=>o!==e.fieldName):[...s||[],e.fieldName])},children:e.title},e.id))}),re=({className:s,label:l,value:n,model:d,onChange:e})=>{x.useState();const[o,f]=x.useState(n?n.split(","):d.fields.filter(r=>r.fieldName!=="id").sort((r,c)=>r.sort-c.sort).map(r=>r.fieldName));return Y(()=>{e(o==null?void 0:o.join(","))},[o]),p("div",{className:`${s} w-full justify-center flex flex-col space-y-2 pb-2 `,children:[t("div",{className:" font-semibold  text-sm",children:l}),t("div",{className:" flex flex-col justify-center w-full ",children:t(T,{className:" w-full",formTitle:"添加字段",actionType:"modal",modal:t(ie,{data:d.fields,value:o,onChange:r=>{alert(r)}}),allowEmpty:!0,submitClose:!0,saveApi:r=>{f(r)},children:t("div",{className:" w-full  items-center flex ",children:p("div",{className:"border bg-white h-10 w-full rounded  flex items-center justify-center hover:border-dashed hover:border-gray-500  hover:bg-gray-100 cursor-pointer ",children:[t("span",{className:" mr-4",children:t("i",{className:" icon-create-network"})}),t("span",{className:"text-sm text-gray-700",children:"添加字段"})]})})})}),o&&o.length>0?t(L,{useDragHandle:!0,className:"p-2  bg-gray-100",value:(o==null?void 0:o.map(r=>{var c,i;return{id:r,name:(c=d.fields.find(a=>a.fieldName===r))==null?void 0:c.title,subName:(i=d.fields.find(a=>a.fieldName===r))==null?void 0:i.fieldName}}))||[],onRemove:r=>{f(c=>c==null?void 0:c.filter(i=>i!==r))},onSortEnd:({oldIndex:r,newIndex:c})=>{f(i=>{const a=Array.from(i);return a.splice(c,0,a.splice(r,1)[0]),a})}}):t("div",{className:" text-red-500 text-sm text-center",children:"请至少选择一个字段在列表进行展示"})]})},le=({value:s,menuModel:l,onChange:n})=>p("div",{className:" h-full flex flex-col",children:[t(j,{fontBold:!0,terse:!0,className:"",type:"sysTabDto",reaction:[N.then("conditionJson","dataLevel","title","sort","formShowType","formId","sysMenuId","viewType","icon","sysTabButtons","fieldNames","sysTabVisits").hide(),N.field("orderType").eq("CUSTOM").then("orderFieldName","orderDirection").show().required(),N.field("orderType").ne("CUSTOM").then("orderFieldName","orderDirection").clearValue()],formData:s,onChange:d=>{n({...s,...d})}},s==null?void 0:s.id),t(re,{className:"",model:l,value:s==null?void 0:s.fieldNames,label:"视图显示字段",onChange:d=>{n({...s,fieldNames:d})}})]}),Te=()=>{const{pathname:s}=O(),l=M(),n=s.split("/").pop(),d=new URLSearchParams(window.location.search),[e,o]=x.useState(),f=d.get("sysTabId"),r=d.get("sysMenuId")||void 0,{model:c}=G({id:n}),[i,a]=x.useState(),[u,h]=x.useState([]),{user:I}=U();x.useEffect(()=>{c&&(f?D(f).then(m=>{o(m.data)}):o({entityId:c.entityId,title:"新建视图",sysMenuId:r,dataLevel:"1",viewType:"table",orderType:"SYS"}))},[f,r,c]),x.useEffect(()=>{n&&(r||e!=null&&e.sysMenuId)&&!i&&q({conditions:{orAnd:"or",where:[{fieldName:"resourcesEntityId",opt:V.eq,value:[n]},{fieldName:"sysMenuId",opt:V.eq,value:[r||(e==null?void 0:e.sysMenuId)]}]}}).then(m=>{a([...m.data||[]])}),W().then(m=>{h(m.data||[])})},[n,r,e==null?void 0:e.sysMenuId,i]);const F=[{label:"基础信息",icon:t("i",{className:"icon-calendar-abstract"})},{label:"数据展示",icon:t("i",{className:"icon-view_eye"})},{label:"数据权限",icon:t("i",{className:" icon-role-approval2"})},{label:"按钮配置",icon:t("i",{className:"  icon-smart_button_black_24dp"})}],[b,P]=x.useState(0),g=x.useMemo(()=>{var y;const m=[];return e!=null&&e.title||m.push("视图名称不能为空"),(e==null?void 0:e.orderType)==="CUSTOM"&&(!e.orderDirection||!e.orderFieldName)&&m.push("自定义排序的字段和方向不能为空"),(e==null?void 0:e.dataLevel)==="CUSTOM"&&(!e.conditionJson||e.conditionJson==="[]")&&m.push("请在[数据权限]里配置至少一个条件筛选规则"),!(e!=null&&e.sysTabVisits)||((y=e==null?void 0:e.sysTabVisits)==null?void 0:y.length)===0?m.push("请至少授权一个角色组访问此视图"):(e==null||e.sysTabVisits.filter(B=>!B.visitButtonIds).length,e==null||e.sysTabVisits.length),m},[e]),R=I==null?void 0:I.menus.find(m=>m.id===r);return t(_,{title:(e==null?void 0:e.title)||"新建视图",children:p("div",{className:"flex h-full  bg-slate-50",children:[t("div",{className:" flex-1 h-full flex flex-col  px-2 pt-2 overflow-hidden",children:c&&e&&t(J,{menu:R||{id:e.sysMenuId},designTabDto:e,superUser:"design",listModelId:c==null?void 0:c.id})}),p("div",{style:{width:"430px"},className:"  flex flex-col border-l bg-white h-full ",children:[p("div",{className:" flex w-full   ",children:[t("span",{className:"text-base px-6 py-2 font-semibold h-12",children:"视图配置"}),t("span",{className:" flex flex-1 items-center text-red-500 text-sm"})]}),p("div",{className:"flex flex-1",children:[t("div",{style:{width:"125px"},className:"border-r flex flex-col px-2 items-center  space-y-1",children:F.map((m,y)=>p("div",{onClick:()=>P(y),className:`w-full ${A({" bg-gray-100 font-semibold !text-black ":b===y})} hover:bg-gray-100 cursor-pointer hover:text-gray-800 text-gray-500 text-sm px-2 space-x-2 h-9 font-chinese rounded-md flex justify-center items-center`,children:[t("div",{children:m.icon}),t("div",{children:m.label})]},y))}),t("div",{id:"rightMain",className:"flex-1 pl-2 pr-4 flex flex-col ",children:t(Q,{autoHide:!0,children:p("div",{className:" mx-2",children:[b===0&&e&&t(C,{className:"",groups:u,value:e,buttonVo:(i==null?void 0:i.filter(m=>{var y;return(y=e.sysTabButtons)==null?void 0:y.some(B=>B.buttonId===m.id)}))||[],onChange:m=>{o(m)}}),b===1&&c&&e&&t(le,{menuModel:c,value:e,onChange:o}),b===2&&e&&t(ee,{value:e,onChange:o}),b===3&&e&&t(se,{buttons:i||[],formId:n,value:(e==null?void 0:e.sysTabButtons)||[],onChange:m=>{o(y=>({...y||{},sysTabButtons:m}))}})]})})})]}),t("div",{className:" p-4 text-base  h-20 space-x-4 flex items-center border-t ",children:t(K,{btns:[{title:"保存",theme:"solid",actionType:"edit",modalOpen:!0,datas:e,usableMatch:()=>g.length>0?g[0]:!0,saveApi:()=>{g.length===0&&e&&z(e).then(m=>{o(m.data)})}},{title:"按钮配置",disabled:b!==3,disabledHide:!0,actionType:"click",allowEmpty:!0,onClick:()=>{l(`/full/advSetting/${n}?tab=3`)}}]})})]})]})})};export{Te as default};
